<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel Pro - Toko Buku</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .view-section { display: none; }
        .view-section.active { display: block; }
        .nav-link.active { background-color: rgb(99 102 241); color: white; }
        .modal { display: none; }
        .modal.active { display: flex; }
        #book-description-editor, #banner-description-editor { min-height: 150px; }
        .ql-container { font-size: 1rem; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex items-center space-x-3">
            <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span>Loading...</span>
        </div>
    </div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 text-white flex-shrink-0">
            <div class="p-4 text-2xl font-bold">Admin Panel Pro</div>
            <nav class="mt-4">
                <a href="#" class="nav-link block px-4 py-2 hover:bg-gray-700" data-view="dashboard-view">Dashboard</a>
                <a href="#" class="nav-link block px-4 py-2 hover:bg-gray-700" data-view="books-view">Kelola Buku</a>
                <a href="#" class="nav-link block px-4 py-2 hover:bg-gray-700" data-view="publishers-view">Kelola Penerbit</a>
                <a href="#" class="nav-link block px-4 py-2 hover:bg-gray-700" data-view="categories-view">Kelola Kategori</a>
                <a href="#" class="nav-link block px-4 py-2 hover:bg-gray-700" data-view="banners-view">Kelola Banner</a>
                <a href="#" class="nav-link block px-4 py-2 hover:bg-gray-700" data-view="flash-sales-view">Kelola Flash Sale</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 overflow-y-auto">
            <!-- Dashboard View -->
            <div id="dashboard-view" class="view-section active">
                <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow"><h3 class="text-sm font-semibold text-gray-500">Total Buku</h3><p class="text-3xl font-bold" id="total-books">-</p></div>
                    <div class="bg-white p-6 rounded-lg shadow"><h3 class="text-sm font-semibold text-gray-500">Total Penerbit</h3><p class="text-3xl font-bold" id="total-publishers">-</p></div>
                    <div class="bg-white p-6 rounded-lg shadow"><h3 class="text-sm font-semibold text-gray-500">Total Banner</h3><p class="text-3xl font-bold" id="total-banners">-</p></div>
                    <div class="bg-white p-6 rounded-lg shadow"><h3 class="text-sm font-semibold text-gray-500">Flash Sale Aktif</h3><p class="text-3xl font-bold" id="active-flash-sales">-</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow"><h2 class="text-xl font-bold mb-4">Buku per Genre</h2><canvas id="genreChart"></canvas></div>
                    <div class="bg-white p-6 rounded-lg shadow"><h2 class="text-xl font-bold mb-4">Penjualan Mingguan (Contoh)</h2><canvas id="salesChart"></canvas></div>
                </div>
            </div>

            <!-- Books View -->
            <div id="books-view" class="view-section">
                <div class="flex justify-between items-center mb-4"><h1 class="text-3xl font-bold">Kelola Buku</h1><button onclick="openBookModal()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">+ Tambah Buku Baru</button></div>
                <input type="text" id="book-search" placeholder="Cari buku..." class="w-full md:w-1/2 px-4 py-2 border rounded-lg mb-4">
                <div class="bg-white p-4 rounded-lg shadow overflow-x-auto"><table class="min-w-full"><thead><tr><th class="px-4 py-2 border-b text-left">Cover</th><th class="px-4 py-2 border-b text-left">Judul</th><th class="px-4 py-2 border-b text-left">Penulis</th><th class="px-4 py-2 border-b text-left">Genre</th><th class="px-4 py-2 border-b text-left">Harga</th><th class="px-4 py-2 border-b text-left">Aksi</th></tr></thead><tbody id="books-table-body"></tbody></table></div>
            </div>

            <!-- Publishers View -->
            <div id="publishers-view" class="view-section">
                <div class="flex justify-between items-center mb-4"><h1 class="text-3xl font-bold">Kelola Penerbit</h1><button onclick="openPublisherModal()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">+ Tambah Penerbit</button></div>
                <div class="bg-white p-4 rounded-lg shadow overflow-x-auto"><table class="min-w-full"><thead><tr><th class="px-4 py-2 border-b text-left">Nama</th><th class="px-4 py-2 border-b text-left">Aksi</th></tr></thead><tbody id="publishers-table-body"></tbody></table></div>
            </div>

            <!-- Categories View -->
            <div id="categories-view" class="view-section">
                <div class="flex justify-between items-center mb-4"><h1 class="text-3xl font-bold">Kelola Kategori</h1><button onclick="openCategoryModal()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">+ Tambah Kategori</button></div>
                <div class="bg-white p-4 rounded-lg shadow overflow-x-auto"><table class="min-w-full"><thead><tr><th class="px-4 py-2 border-b text-left">Nama (ID)</th><th class="px-4 py-2 border-b text-left">Nama (EN)</th><th class="px-4 py-2 border-b text-left">Aksi</th></tr></thead><tbody id="categories-table-body"></tbody></table></div>
            </div>

            <!-- Banners View -->
            <div id="banners-view" class="view-section">
                <div class="flex justify-between items-center mb-4"><h1 class="text-3xl font-bold">Kelola Banner</h1><button onclick="openBannerModal()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">+ Tambah Banner</button></div>
                <div class="bg-white p-4 rounded-lg shadow overflow-x-auto"><table class="min-w-full"><thead><tr><th class="px-4 py-2 border-b text-left">Gambar</th><th class="px-4 py-2 border-b text-left">Judul</th><th class="px-4 py-2 border-b text-left">Tipe</th><th class="px-4 py-2 border-b text-left">Status</th><th class="px-4 py-2 border-b text-left">Aksi</th></tr></thead><tbody id="banners-table-body"></tbody></table></div>
            </div>

            <!-- Flash Sales View -->
            <div id="flash-sales-view" class="view-section">
                <div class="flex justify-between items-center mb-4"><h1 class="text-3xl font-bold">Kelola Flash Sale</h1><button onclick="openFlashSaleModal()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">+ Tambah Flash Sale</button></div>
                <div class="bg-white p-4 rounded-lg shadow overflow-x-auto"><table class="min-w-full"><thead><tr><th class="px-4 py-2 border-b text-left">Buku</th><th class="px-4 py-2 border-b text-left">Diskon</th><th class="px-4 py-2 border-b text-left">Harga Sale</th><th class="px-4 py-2 border-b text-left">Status</th><th class="px-4 py-2 border-b text-left">Aksi</th></tr></thead><tbody id="flash-sales-table-body"></tbody></table></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="book-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto"><div class="p-6"><h2 class="text-2xl font-bold mb-4">Form Buku</h2><form id="book-form" class="space-y-4"><input type="hidden" id="book-id"><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium">Judul</label><input type="text" id="book-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div><label class="block text-sm font-medium">Penulis</label><input type="text" id="book-author" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div><label class="block text-sm font-medium">Penerbit</label><select id="book-publisher" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select></div><div><label class="block text-sm font-medium">Genre</label><input type="text" id="book-genre" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div><div><label class="block text-sm font-medium">Harga (USD)</label><input type="number" id="book-price" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div><label class="block text-sm font-medium">Cover Image</label><input type="file" id="book-cover-image" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"></div></div><div><label class="block text-sm font-medium">Deskripsi</label><div id="book-description-editor" class="mt-1 bg-white"></div></div><div class="flex justify-end space-x-2"><button type="button" onclick="closeBookModal()" class="bg-gray-500 text-white px-4 py-2 rounded">Batal</button><button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Simpan</button></div></form></div></div>
    </div>
    <div id="publisher-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4"><div class="p-6"><h2 class="text-2xl font-bold mb-4">Form Penerbit</h2><form id="publisher-form" class="space-y-4"><input type="hidden" id="publisher-id"><div><label class="block text-sm font-medium">Nama Penerbit</label><input type="text" id="publisher-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div class="flex justify-end space-x-2"><button type="button" onclick="closePublisherModal()" class="bg-gray-500 text-white px-4 py-2 rounded">Batal</button><button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Simpan</button></div></form></div></div>
    </div>
    <div id="category-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4"><div class="p-6"><h2 class="text-2xl font-bold mb-4">Form Kategori</h2><form id="category-form" class="space-y-4"><input type="hidden" id="category-id"><div><label class="block text-sm font-medium">Nama (ID)</label><input type="text" id="category-name-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div><label class="block text-sm font-medium">Nama (EN)</label><input type="text" id="category-name-en" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div><label class="block text-sm font-medium">Nama (AR)</label><input type="text" id="category-name-ar" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div class="flex justify-end space-x-2"><button type="button" onclick="closeCategoryModal()" class="bg-gray-500 text-white px-4 py-2 rounded">Batal</button><button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Simpan</button></div></form></div></div>
    </div>
    <div id="banner-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4"><div class="p-6"><h2 class="text-2xl font-bold mb-4">Form Banner</h2><form id="banner-form" class="space-y-4"><input type="hidden" id="banner-id"><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium">Judul</label><input type="text" id="banner-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div><label class="block text-sm font-medium">Tipe</label><select id="banner-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="main">Main</option><option value="promo">Promo</option><option value="category">Category</option></select></div><div><label class="block text-sm font-medium">Target URL</label><input type="text" id="banner-target-url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div><div><label class="block text-sm font-medium">Status</label><select id="banner-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="active">Active</option><option value="inactive">Inactive</option></select></div><div class="md:col-span-2"><label class="block text-sm font-medium">Banner Image</label><input type="file" id="banner-image" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"></div></div><div><label class="block text-sm font-medium">Deskripsi</label><div id="banner-description-editor" class="mt-1 bg-white"></div></div><div class="flex justify-end space-x-2"><button type="button" onclick="closeBannerModal()" class="bg-gray-500 text-white px-4 py-2 rounded">Batal</button><button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Simpan</button></div></form></div></div>
    </div>
    <div id="flash-sale-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4"><div class="p-6"><h2 class="text-2xl font-bold mb-4">Form Flash Sale</h2><form id="flash-sale-form" class="space-y-4"><input type="hidden" id="flash-sale-id"><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium">Pilih Buku</label><select id="fs-book-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select></div><div><label class="block text-sm font-medium">Status</label><select id="fs-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="upcoming">Upcoming</option><option value="active">Active</option><option value="ended">Ended</option></select></div><div><label class="block text-sm font-medium">Judul Flash Sale</label><input type="text" id="fs-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div><label class="block text-sm font-medium">Diskon (%)</label><input type="number" id="fs-discount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div><label class="block text-sm font-medium">Harga Awal (USD)</label><input type="number" id="fs-original-price" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div><label class="block text-sm font-medium">Harga Sale (USD)</label><input type="number" id="fs-sale-price" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div><label class="block text-sm font-medium">Jumlah Limit</label><input type="number" id="fs-quantity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div><label class="block text-sm font-medium">Waktu Mulai</label><input type="datetime-local" id="fs-start-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div><label class="block text-sm font-medium">Waktu Selesai</label><input type="datetime-local" id="fs-end-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div></div><div class="flex justify-end space-x-2"><button type="button" onclick="closeFlashSaleModal()" class="bg-gray-500 text-white px-4 py-2 rounded">Batal</button><button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Simpan</button></div></form></div></div>
    </div>

    <script>
        // --- CONFIG & UTILS ---
        const SUPABASE_URL = 'https://wuaqtzyreudwyasxnaxy.supabase.co';
        const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1YXF0enlyZXVkd3lhc3huYXh5Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDU4MDc2MCwiZXhwIjoyMDc2MTU2NzYwfQ.eguVN_msr9PhULxU3kmKy4sr_FCA-lOvScB84GF9Kjs';
        const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
        const showToast = (message, type = 'success') => Toastify({ text: message, duration: 3000, gravity: "top", position: "right", style: { background: type === 'success' ? "#22c55e" : "#ef4444" } }).showToast();
        const showLoading = () => document.getElementById('loading-overlay').classList.remove('hidden');
        const hideLoading = () => document.getElementById('loading-overlay').classList.add('hidden');

        // --- VIEW MANAGEMENT ---
        const navLinks = document.querySelectorAll('.nav-link'); const viewSections = document.querySelectorAll('.view-section');
        function showView(viewId) { viewSections.forEach(s => s.classList.remove('active')); navLinks.forEach(l => l.classList.remove('active')); document.getElementById(viewId).classList.add('active'); document.querySelector(`[data-view="${viewId}"]`).classList.add('active'); if (viewId === 'dashboard-view') loadDashboard(); if (viewId === 'books-view') fetchBooks(); if (viewId === 'publishers-view') fetchPublishers(); if (viewId === 'categories-view') fetchCategories(); if (viewId === 'banners-view') fetchBanners(); if (viewId === 'flash-sales-view') fetchFlashSales(); }
        navLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); showView(link.dataset.view); }));

        // --- DASHBOARD ---
        let genreChart, salesChart;
        async function loadDashboard() { showLoading(); const [booksRes, publishersRes, bannersRes, flashSalesRes] = await Promise.all([supabase.from('books').select('*', { count: 'exact', head: true }), supabase.from('publishers').select('*', { count: 'exact', head: true }), supabase.from('banners').select('*', { count: 'exact', head: true }), supabase.from('flash_sales').select('*', { count: 'exact', head: true }).eq('status', 'active')]); document.getElementById('total-books').innerText = booksRes.count || 0; document.getElementById('total-publishers').innerText = publishersRes.count || 0; document.getElementById('total-banners').innerText = bannersRes.count || 0; document.getElementById('active-flash-sales').innerText = flashSalesRes.count || 0; const { data: genreData } = await supabase.from('books').select('genre'); const genreCounts = genreData.reduce((acc, book) => { acc[book.genre] = (acc[book.genre] || 0) + 1; return acc; }, {}); const ctx1 = document.getElementById('genreChart').getContext('2d'); if (genreChart) genreChart.destroy(); genreChart = new Chart(ctx1, { type: 'bar', data: { labels: Object.keys(genreCounts), datasets: [{ label: 'Jumlah Buku', data: Object.values(genreCounts), backgroundColor: 'rgba(99, 102, 241, 0.5)' }] }, options: { scales: { y: { beginAtZero: true } } } }); const ctx2 = document.getElementById('salesChart').getContext('2d'); if (salesChart) salesChart.destroy(); salesChart = new Chart(ctx2, { type: 'line', data: { labels: ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'], datasets: [{ label: 'Penjualan', data: [12, 19, 3, 5, 2, 8, 15], fill: false, borderColor: 'rgb(75, 192, 192)' }] } }); hideLoading(); }

        // --- BOOKS ---
        let quillBook; document.addEventListener('DOMContentLoaded', () => { quillBook = new Quill('#book-description-editor', { theme: 'snow', placeholder: 'Tulis deskripsi buku...' }); showView('dashboard-view'); });
        const bookModal = document.getElementById('book-modal'); const bookForm = document.getElementById('book-form'); const bookSearch = document.getElementById('book-search');
        bookForm.addEventListener('submit', handleBookSubmit); bookSearch.addEventListener('input', () => fetchBooks(bookSearch.value));
        function openBookModal(book = null) { if (book) { document.getElementById('book-id').value = book.id; document.getElementById('book-title').value = book.title; document.getElementById('book-author').value = book.author; document.getElementById('book-genre').value = book.genre || ''; document.getElementById('book-price').value = book.price_usd; quillBook.root.innerHTML = book.description || ''; } else { bookForm.reset(); quillBook.setText(''); } fetchPublishersForSelect(); bookModal.classList.add('active'); } function closeBookModal() { bookModal.classList.remove('active'); }
        async function handleBookSubmit(e) { e.preventDefault(); showLoading(); const bookId = document.getElementById('book-id').value; let bookData = { title: document.getElementById('book-title').value, author: document.getElementById('book-author').value, publisher_id: document.getElementById('book-publisher').value, genre: document.getElementById('book-genre').value, price_usd: parseFloat(document.getElementById('book-price').value), description: quillBook.root.innerHTML, }; const imageFile = document.getElementById('book-cover-image').files[0]; if (imageFile) { const { data: uploadData, error: uploadError } = await supabase.storage.from('public-images').upload(`covers/${Date.now()}-${imageFile.name}`, imageFile); if (uploadError) { showToast('Gagal upload gambar: ' + uploadError.message, 'error'); hideLoading(); return; } const { data: { publicUrl } } = supabase.storage.from('public-images').getPublicUrl(uploadData.path); bookData.cover_image_url = publicUrl; } let error; if (bookId) ({ error } = await supabase.from('books').update(bookData).eq('id', bookId)); else ({ error } = await supabase.from('books').insert(bookData)); if (error) showToast('Gagal menyimpan buku: ' + error.message, 'error'); else { showToast('Buku berhasil disimpan!'); closeBookModal(); fetchBooks(); } hideLoading(); }
        async function fetchBooks(searchTerm = '') { showLoading(); let query = supabase.from('books').select('*, publishers(name)'); if (searchTerm) query = query.or(`title.ilike.%${searchTerm}%,author.ilike.%${searchTerm}%`); const { data, error } = await query; if (error) { showToast('Gagal memuat data buku', 'error'); hideLoading(); return; } const tbody = document.getElementById('books-table-body'); tbody.innerHTML = data.map(book => `<tr><td class="px-4 py-2 border-b"><img src="${book.cover_image_url || 'https://via.placeholder.com/50'}" alt="cover" class="w-12 h-16 object-cover rounded"></td><td class="px-4 py-2 border-b font-semibold">${book.title}</td><td class="px-4 py-2 border-b">${book.author}</td><td class="px-4 py-2 border-b">${book.genre || '-'}</td><td class="px-4 py-2 border-b">$${book.price_usd}</td><td class="px-4 py-2 border-b"><button onclick="openBookModal(${JSON.stringify(book)})" class="bg-yellow-500 text-white px-2 py-1 rounded text-sm mr-1">Edit</button><button onclick="deleteItem('books', '${book.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm">Hapus</button></td></tr>`).join(''); hideLoading(); }
        async function deleteItem(table, id) { if (!confirm('Yakin ingin menghapus?')) return; showLoading(); const { error } = await supabase.from(table).delete().eq('id', id); if (error) showToast('Gagal menghapus', 'error'); else { showToast('Data dihapus!'); if (table === 'books') fetchBooks(); if (table === 'publishers') fetchPublishers(); if (table === 'categories') fetchCategories(); if (table === 'banners') fetchBanners(); if (table === 'flash_sales') fetchFlashSales(); } hideLoading(); }
        async function fetchPublishersForSelect() { const { data } = await supabase.from('publishers').select('id, name'); const select = document.getElementById('book-publisher'); select.innerHTML = '<option value="">Pilih Penerbit</option>' + data.map(p => `<option value="${p.id}">${p.name}</option>`).join(''); }

        // --- PUBLISHERS ---
        const publisherModal = document.getElementById('publisher-modal'); const publisherForm = document.getElementById('publisher-form');
        publisherForm.addEventListener('submit', async (e) => { e.preventDefault(); showLoading(); const pubId = document.getElementById('publisher-id').value; const pubData = { name: document.getElementById('publisher-name').value }; let error; if (pubId) ({ error } = await supabase.from('publishers').update(pubData).eq('id', pubId)); else ({ error } = await supabase.from('publishers').insert(pubData)); if (error) showToast('Gagal menyimpan penerbit', 'error'); else { showToast('Penerbit disimpan!'); closePublisherModal(); fetchPublishers(); } hideLoading(); });
        function openPublisherModal(pub = null) { if (pub) { document.getElementById('publisher-id').value = pub.id; document.getElementById('publisher-name').value = pub.name; } else { publisherForm.reset(); } publisherModal.classList.add('active'); } function closePublisherModal() { publisherModal.classList.remove('active'); }
        async function fetchPublishers() { showLoading(); const { data, error } = await supabase.from('publishers').select('*'); if (error) { showToast('Gagal memuat data penerbit', 'error'); hideLoading(); return; } const tbody = document.getElementById('publishers-table-body'); tbody.innerHTML = data.map(pub => `<tr><td class="px-4 py-2 border-b">${pub.name}</td><td class="px-4 py-2 border-b"><button onclick="openPublisherModal(${JSON.stringify(pub)})" class="bg-yellow-500 text-white px-2 py-1 rounded text-sm mr-1">Edit</button><button onclick="deleteItem('publishers', '${pub.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm">Hapus</button></td></tr>`).join(''); hideLoading(); }

        // --- CATEGORIES ---
        let quillCategory; document.addEventListener('DOMContentLoaded', () => { quillCategory = new Quill('#category-description-editor', { theme: 'snow' }); });
        const categoryModal = document.getElementById('category-modal'); const categoryForm = document.getElementById('category-form');
        categoryForm.addEventListener('submit', async (e) => { e.preventDefault(); showLoading(); const catId = document.getElementById('category-id').value; const catData = { name_id: document.getElementById('category-name-id').value, name_en: document.getElementById('category-name-en').value, name_ar: document.getElementById('category-name-ar').value }; let error; if (catId) ({ error } = await supabase.from('categories').update(catData).eq('id', catId)); else ({ error } = await supabase.from('categories').insert(catData)); if (error) showToast('Gagal menyimpan kategori', 'error'); else { showToast('Kategori disimpan!'); closeCategoryModal(); fetchCategories(); } hideLoading(); });
        function openCategoryModal(cat = null) { if (cat) { document.getElementById('category-id').value = cat.id; document.getElementById('category-name-id').value = cat.name_id; document.getElementById('category-name-en').value = cat.name_en; document.getElementById('category-name-ar').value = cat.name_ar; } else { categoryForm.reset(); } categoryModal.classList.add('active'); } function closeCategoryModal() { categoryModal.classList.remove('active'); }
        async function fetchCategories() { showLoading(); const { data, error } = await supabase.from('categories').select('*'); if (error) { showToast('Gagal memuat data kategori', 'error'); hideLoading(); return; } const tbody = document.getElementById('categories-table-body'); tbody.innerHTML = data.map(cat => `<tr><td class="px-4 py-2 border-b">${cat.name_id}</td><td class="px-4 py-2 border-b">${cat.name_en}</td><td class="px-4 py-2 border-b"><button onclick="openCategoryModal(${JSON.stringify(cat)})" class="bg-yellow-500 text-white px-2 py-1 rounded text-sm mr-1">Edit</button><button onclick="deleteItem('categories', '${cat.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm">Hapus</button></td></tr>`).join(''); hideLoading(); }

        // --- BANNERS ---
        let quillBanner; document.addEventListener('DOMContentLoaded', () => { quillBanner = new Quill('#banner-description-editor', { theme: 'snow' }); });
        const bannerModal = document.getElementById('banner-modal'); const bannerForm = document.getElementById('banner-form');
        bannerForm.addEventListener('submit', async (e) => { e.preventDefault(); showLoading(); const bannerId = document.getElementById('banner-id').value; let bannerData = { title: document.getElementById('banner-title').value, type: document.getElementById('banner-type').value, target_url: document.getElementById('banner-target-url').value, status: document.getElementById('banner-status').value, description: quillBanner.root.innerHTML, }; const imageFile = document.getElementById('banner-image').files[0]; if (imageFile) { const { data: uploadData, error: uploadError } = await supabase.storage.from('public-images').upload(`banners/${Date.now()}-${imageFile.name}`, imageFile); if (uploadError) { showToast('Gagal upload gambar: ' + uploadError.message, 'error'); hideLoading(); return; } const { data: { publicUrl } } = supabase.storage.from('public-images').getPublicUrl(uploadData.path); bannerData.image_url = publicUrl; } let error; if (bannerId) ({ error } = await supabase.from('banners').update(bannerData).eq('id', bannerId)); else ({ error } = await supabase.from('banners').insert(bannerData)); if (error) showToast('Gagal menyimpan banner', 'error'); else { showToast('Banner disimpan!'); closeBannerModal(); fetchBanners(); } hideLoading(); });
        function openBannerModal(banner = null) { if (banner) { document.getElementById('banner-id').value = banner.id; document.getElementById('banner-title').value = banner.title; document.getElementById('banner-type').value = banner.type; document.getElementById('banner-target-url').value = banner.target_url; document.getElementById('banner-status').value = banner.status; quillBanner.root.innerHTML = banner.description || ''; } else { bannerForm.reset(); quillBanner.setText(''); } bannerModal.classList.add('active'); } function closeBannerModal() { bannerModal.classList.remove('active'); }
        async function fetchBanners() { showLoading(); const { data, error } = await supabase.from('banners').select('*').order('display_order'); if (error) { showToast('Gagal memuat data banner', 'error'); hideLoading(); return; } const tbody = document.getElementById('banners-table-body'); tbody.innerHTML = data.map(b => `<tr><td class="px-4 py-2 border-b"><img src="${b.image_url || 'https://via.placeholder.com/100x50'}" alt="banner" class="w-24 h-12 object-cover rounded"></td><td class="px-4 py-2 border-b">${b.title}</td><td class="px-4 py-2 border-b">${b.type}</td><td class="px-4 py-2 border-b">${b.status}</td><td class="px-4 py-2 border-b"><button onclick="openBannerModal(${JSON.stringify(b)})" class="bg-yellow-500 text-white px-2 py-1 rounded text-sm mr-1">Edit</button><button onclick="deleteItem('banners', '${b.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm">Hapus</button></td></tr>`).join(''); hideLoading(); }

        // --- FLASH SALES ---
        const flashSaleModal = document.getElementById('flash-sale-modal'); const flashSaleForm = document.getElementById('flash-sale-form');
        flashSaleForm.addEventListener('submit', async (e) => { e.preventDefault(); showLoading(); const fsId = document.getElementById('flash-sale-id').value; const fsData = { book_id: document.getElementById('fs-book-id').value, title: document.getElementById('fs-title').value, discount_percentage: parseInt(document.getElementById('fs-discount').value), original_price_usd: parseFloat(document.getElementById('fs-original-price').value), flash_sale_price_usd: parseFloat(document.getElementById('fs-sale-price').value), quantity_limit: parseInt(document.getElementById('fs-quantity').value), status: document.getElementById('fs-status').value, start_time: document.getElementById('fs-start-time').value, end_time: document.getElementById('fs-end-time').value, }; let error; if (fsId) ({ error } = await supabase.from('flash_sales').update(fsData).eq('id', fsId)); else ({ error } = await supabase.from('flash_sales').insert(fsData)); if (error) showToast('Gagal menyimpan flash sale', 'error'); else { showToast('Flash Sale disimpan!'); closeFlashSaleModal(); fetchFlashSales(); } hideLoading(); });
        function openFlashSaleModal(fs = null) { if (fs) { document.getElementById('flash-sale-id').value = fs.id; document.getElementById('fs-book-id').value = fs.book_id; document.getElementById('fs-title').value = fs.title; document.getElementById('fs-discount').value = fs.discount_percentage; document.getElementById('fs-original-price').value = fs.original_price_usd; document.getElementById('fs-sale-price').value = fs.flash_sale_price_usd; document.getElementById('fs-quantity').value = fs.quantity_limit; document.getElementById('fs-status').value = fs.status; document.getElementById('fs-start-time').value = new Date(fs.start_time).toISOString().slice(0, 16); document.getElementById('fs-end-time').value = new Date(fs.end_time).toISOString().slice(0, 16); } else { flashSaleForm.reset(); } fetchBooksForFlashSale(); flashSaleModal.classList.add('active'); } function closeFlashSaleModal() { flashSaleModal.classList.remove('active'); }
        async function fetchFlashSales() { showLoading(); const { data, error } = await supabase.from('flash_sales').select('*, books(title, author)'); if (error) { showToast('Gagal memuat data flash sale', 'error'); hideLoading(); return; } const tbody = document.getElementById('flash-sales-table-body'); tbody.innerHTML = data.map(fs => `<tr><td class="px-4 py-2 border-b">${fs.books.title} by ${fs.books.author}</td><td class="px-4 py-2 border-b">${fs.discount_percentage}%</td><td class="px-4 py-2 border-b">$${fs.flash_sale_price_usd}</td><td class="px-4 py-2 border-b">${fs.status}</td><td class="px-4 py-2 border-b"><button onclick="openFlashSaleModal(${JSON.stringify(fs)})" class="bg-yellow-500 text-white px-2 py-1 rounded text-sm mr-1">Edit</button><button onclick="deleteItem('flash_sales', '${fs.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm">Hapus</button></td></tr>`).join(''); hideLoading(); }
        async function fetchBooksForFlashSale() { const { data } = await supabase.from('books').select('id, title'); const select = document.getElementById('fs-book-id'); select.innerHTML = '<option value="">Pilih Buku</option>' + data.map(b => `<option value="${b.id}">${b.title}</option>`).join(''); }
    </script>
</body>
</html>
