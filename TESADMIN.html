<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin Lengkap - Toko Buku Islam</title>
    
    <!-- ========================= CSS START ========================= -->
    <style>
        /* General Styles */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 0; }
        .container { max-width: 1400px; margin: 0 auto; background-color: #fff; min-height: 100vh; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        header { background-color: #2c3e50; color: white; padding: 1rem 2rem; text-align: center; }
        header h1 { margin: 0; font-size: 1.8rem; }
        nav { background-color: #34495e; display: flex; justify-content: center; flex-wrap: wrap; }
        .nav-btn { background-color: transparent; color: white; border: none; padding: 15px 25px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        .nav-btn:hover { background-color: #2c3e50; }
        .nav-btn.active { background-color: #3498db; }
        main { padding: 2rem; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        h2 { color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 20px; }

        /* Form Styles */
        .form-section { margin-bottom: 40px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #fafafa; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-grid input, .form-grid select { padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .form-grid input:focus, .form-grid select:focus { outline: none; border-color: #3498db; box-shadow: 0 0 5px rgba(52, 152, 219, 0.5); }
        .form-grid input[readonly] { background-color: #e9ecef; }
        .form-buttons button { padding: 12px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; margin-right: 10px; }
        .submit-btn { background-color: #2ecc71; color: white; }
        .submit-btn:hover { background-color: #27ae60; }
        .cancel-btn { background-color: #e74c3c; color: white; }
        .cancel-btn:hover { background-color: #c0392b; }

        /* Image Upload Styles */
        .image-upload-container { margin-top: 10px; }
        .image-upload-container label { display: block; margin-bottom: 5px; font-weight: bold; }
        .image-preview { max-width: 200px; max-height: 200px; border: 1px solid #ccc; border-radius: 4px; display: block; margin-top: 10px; background-color: #f9f9f9; object-fit: contain; }
        .image-source-selector { margin-bottom: 10px; }
        .image-source-selector label { margin-right: 15px; font-weight: normal; }

        /* Table Styles */
        .table-wrapper { overflow-x: auto; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .admin-table th, .admin-table td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #ddd; font-size: 14px; }
        .admin-table th { background-color: #ecf0f1; font-weight: bold; }
        .admin-table tbody tr:hover { background-color: #f9f9f9; }
        .action-buttons button { padding: 6px 12px; margin-right: 5px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .edit-btn { background-color: #f39c12; color: white; }
        .edit-btn:hover { background-color: #e67e22; }
        .delete-btn { background-color: #e74c3c; color: white; }
        .delete-btn:hover { background-color: #c0392b; }
        #loadingMessage { text-align: center; padding: 20px; font-style: italic; color: #777; }

        /* Style for images inside tables */
        .table-image { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #eee; }
        
        /* Style for currency selector */
        .currency-selector { margin-bottom: 1rem; }
        .currency-selector select { padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; }
        
        /* NEW: Price display styles */
        .price-display { display: flex; flex-direction: column; }
        .original-price { text-decoration: line-through; color: #888; font-size: 0.9em; }
        .discounted-price { color: #e74c3c; font-weight: bold; }
        .discount-badge { background-color: #e74c3c; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-left: 5px; }
        
        /* NEW: Form price display */
        .price-calculator { background-color: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px; }
        .price-calculator h4 { margin: 0 0 10px 0; color: #2c3e50; }
        .price-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .price-label { font-weight: bold; }
    </style>
    <!-- ========================= CSS END ========================= -->

</head>
<body>

    <div class="container">
        <header><h1>üìö Panel Admin - Toko Buku Islam</h1></header>
        <nav>
            <button class="nav-btn active" data-section="books">üìñ Buku</button>
            <button class="nav-btn" data-section="publishers">üè¢ Penerbit</button>
            <button class="nav-btn" data-section="categories">üìÅ Kategori</button>
            <button class="nav-btn" data-section="banners">üñºÔ∏è Banner</button>
            <button class="nav-btn" data-section="orders">üõí Pesanan</button>
            <button class="nav-btn" data-section="currency">üí± Pengaturan Harga</button>
        </nav>
        <main>
            <!-- ========================= SECTION BUKU (DIPERBARUI) ========================= -->
            <section id="books-section" class="content-section active">
                <div class="form-section">
                    <h2 id="booksFormTitle">Tambah Buku Baru</h2>
                    <form id="bookForm">
                        <input type="hidden" id="bookId">
                        <input type="hidden" id="bookOldCoverUrl">
                        <div class="form-grid">
                            <input type="text" id="bookTitle" placeholder="Judul Buku" required>
                            <input type="text" id="bookAuthor" placeholder="Penulis" required>
                            <input type="number" step="0.01" id="bookOriginalPrice" placeholder="Harga Asli (USD)" required>
                            <input type="number" step="0.01" id="bookBasePrice" placeholder="Harga Dasar (USD)" required>
                            <!-- NEW: Publisher and Discount Fields -->
                            <select id="bookPublisherSelect" placeholder="Pilih Penerbit">
                                <option value="">-- Pilih Penerbit --</option>
                            </select>
                            <input type="text" id="bookDiscount" placeholder="Diskon (contoh: 10%)">
                            <input type="text" id="bookVolumes" placeholder="Jilid">
                            <input type="text" id="bookPages" placeholder="Halaman">
                            <input type="text" id="bookYear" placeholder="Tahun Terbit">
                        </div>
                        
                        <!-- NEW: Price Calculator -->
                        <div class="price-calculator">
                            <h4>Kalkulator Harga Setelah Diskon</h4>
                            <div class="price-row">
                                <span class="price-label">Harga Dasar (USD):</span>
                                <span id="displayBasePriceUSD">$0.00</span>
                            </div>
                            <div class="price-row">
                                <span class="price-label">Diskon:</span>
                                <span id="displayDiscountPercent">0%</span>
                            </div>
                            <div class="price-row">
                                <span class="price-label">Harga Setelah Diskon (USD):</span>
                                <span id="displayFinalPriceUSD" class="discounted-price">$0.00</span>
                            </div>
                            <div class="price-row">
                                <span class="price-label">Harga Setelah Diskon (IDR):</span>
                                <span id="displayFinalPriceIDR" class="discounted-price">Rp 0</span>
                            </div>
                            <div class="price-row">
                                <span class="price-label">Harga Setelah Diskon (EGP):</span>
                                <span id="displayFinalPriceEGP" class="discounted-price">E¬£ 0</span>
                            </div>
                        </div>
                        
                        <!-- NEW: Image Source Selection -->
                        <div class="image-upload-container">
                            <label>Sampul Buku</label>
                            <div class="image-source-selector">
                                <label><input type="radio" name="bookImageSource" value="upload" checked> Unggah File</label>
                                <label><input type="radio" name="bookImageSource" value="url"> Gunakan URL</label>
                            </div>
                            <input type="file" id="bookCoverImageFile" accept="image/*">
                            <input type="url" id="bookCoverImageUrl" placeholder="Masukkan URL gambar" style="display:none;">
                            <img id="bookImagePreview" class="image-preview" src="" alt="Preview Sampul" style="display:none;">
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="submit-btn">Tambah Buku</button>
                            <button type="button" class="cancel-btn" id="cancelEditBook" style="display:none;">Batal</button>
                        </div>
                    </form>
                </div>
                <h2>Daftar Buku</h2>
                <div class="table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Gambar</th>
                                <th>Informasi</th>
                                <th>Harga USD</th>
                                <th>Harga IDR</th>
                                <th>Harga EGP</th>
                                <th>Diskon</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="booksTableBody"></tbody>
                    </table>
                    <p id="loadingBooks">Memuat data...</p>
                </div>
            </section>

            <!-- ========================= SECTION PENERBIT ========================= -->
            <section id="publishers-section" class="content-section">
                <div class="form-section"><h2 id="publishersFormTitle">Tambah Penerbit Baru</h2><form id="publisherForm"><input type="hidden" id="publisherId"><input type="hidden" id="publisherOldLogoUrl"><div class="form-grid"><input type="text" id="publisherName" placeholder="Nama Penerbit" required><input type="text" id="publisherLetter" placeholder="Huruf" required><input type="text" id="publisherDiscount" placeholder="Diskon (contoh: 10%)"></div><div class="image-upload-container"><label for="publisherLogoFile">Logo Penerbit</label><input type="file" id="publisherLogoFile" accept="image/*"><img id="publisherImagePreview" class="image-preview" src="" alt="Preview Logo" style="display:none;"></div><div class="form-buttons"><button type="submit" class="submit-btn">Tambah Penerbit</button><button type="button" class="cancel-btn" id="cancelEditPublisher" style="display:none;">Batal</button></div></form></div><h2>Daftar Penerbit</h2><div class="table-wrapper"><table class="admin-table"><thead><tr><th>Logo</th><th>Nama</th><th>Huruf</th><th>Diskon</th><th>Aksi</th></tr></thead><tbody id="publishersTableBody"></tbody></table><p id="loadingPublishers">Memuat data...</p></div>
            </section>

            <!-- ========================= SECTION KATEGORI (DIPERBARUI) ========================= -->
            <section id="categories-section" class="content-section">
                <div class="form-section">
                    <h2 id="categoriesFormTitle">Tambah Kategori Baru</h2>
                    <form id="categoryForm">
                        <input type="hidden" id="categoryId">
                        <input type="hidden" id="categoryOldImageUrl">
                        <div class="form-grid">
                            <input type="text" id="categoryNameId" placeholder="Nama (ID)" required>
                            <input type="text" id="categoryNameEn" placeholder="Nama (EN)" required>
                            <input type="text" id="categoryNameAr" placeholder="Nama (AR)" required>
                            <input type="color" id="categoryColor" placeholder="Warna">
                            <!-- NEW: Link is now readonly and auto-generated -->
                            <input type="text" id="categoryLink" placeholder="Link Kategori" readonly>
                        </div>
                        <div class="image-upload-container">
                            <label for="categoryImageFile">Gambar Kategori</label>
                            <input type="file" id="categoryImageFile" accept="image/*">
                            <img id="categoryImagePreview" class="image-preview" src="" alt="Preview Gambar" style="display:none;">
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="submit-btn">Tambah Kategori</button>
                            <button type="button" class="cancel-btn" id="cancelEditCategory" style="display:none;">Batal</button>
                        </div>
                    </form>
                </div>
                <h2>Daftar Kategori</h2>
                <div class="table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Gambar</th>
                                <th>Nama (ID)</th>
                                <th>Nama (EN)</th>
                                <th>Warna</th>
                                <th>Link</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesTableBody"></tbody>
                    </table>
                    <p id="loadingCategories">Memuat data...</p>
                </div>
            </section>

            <!-- ========================= SECTION BANNER ========================= -->
            <section id="banners-section" class="content-section">
                <div class="form-section"><h2 id="bannersFormTitle">Tambah Banner Baru</h2><form id="bannerForm"><input type="hidden" id="bannerId"><input type="hidden" id="bannerOldImageUrl"><div class="form-grid"><input type="text" id="bannerTitle" placeholder="Judul Banner" required><input type="text" id="bannerType" placeholder="Tipe (contoh: promo)" required><input type="number" id="bannerDisplayOrder" placeholder="Urutan Tampil"></div><div class="image-upload-container"><label for="bannerImageFile">Gambar Banner</label><input type="file" id="bannerImageFile" accept="image/*"><img id="bannerImagePreview" class="image-preview" src="" alt="Preview Gambar" style="display:none;"></div><div class="form-buttons"><button type="submit" class="submit-btn">Tambah Banner</button><button type="button" class="cancel-btn" id="cancelEditBanner" style="display:none;">Batal</button></div></form></div><h2>Daftar Banner</h2><div class="table-wrapper"><table class="admin-table"><thead><tr><th>Gambar</th><th>Judul</th><th>Tipe</th><th>Urutan</th><th>Aksi</th></tr></thead><tbody id="bannersTableBody"></tbody></table><p id="loadingBanners">Memuat data...</p></div>
            </section>

            <!-- ========================= SECTION PESANAN ========================= -->
            <section id="orders-section" class="content-section">
                <h2>Daftar Pesanan</h2><div class="table-wrapper"><table class="admin-table"><thead><tr><th>Nama Pelanggan</th><th>Buku</th><th>Total (IDR)</th><th>Status</th><th>Tanggal</th></tr></thead><tbody id="ordersTableBody"></tbody></table><p id="loadingOrders">Memuat data...</p></div>
            </section>

            <!-- ========================= SECTION CURRENCY SETTINGS ========================= -->
            <section id="currency-section" class="content-section">
                <div class="form-section">
                    <h2>Pengaturan Kurs Mata Uang</h2>
                    <p>Harga dasar produk disimpan dalam USD. Atur kurs di sini untuk mengonversi harga saat ditampilkan.</p>
                    <form id="currencyForm">
                        <div class="form-grid">
                            <div>
                                <label for="usdToIdr">USD ke IDR</label>
                                <input type="number" id="usdToIdr" required>
                            </div>
                            <div>
                                <label for="usdToEgp">USD ke EGP</label>
                                <input type="number" id="usdToEgp" required>
                            </div>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="submit-btn">Simpan Pengaturan</button>
                        </div>
                    </form>
                </div>
            </section>

        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- ========================= JAVASCRIPT START ========================= -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const supabaseUrl = 'https://rfqpsuzmonfmnvthxinb.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmcXBzdXptb25mbW52dGh4aW5iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1OTQyMjUsImV4cCI6MjA3NjE3MDIyNX0.gJFzuE-KJrdSoIKMTIDszTdNLDl_sJkIhgo7wmXRGWA';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        const STORAGE_BUCKET = 'images';

        let currencySettings = { usd_rate: 15000, egp_rate: 500 };
        let allPublishers = []; // Store all publishers globally

        // --- KONFIGURASI MANAJEMEN SECTION ---
        const sections = document.querySelectorAll('.content-section');
        const navButtons = document.querySelectorAll('.nav-btn');
        function showSection(sectionId) {
            sections.forEach(section => section.classList.remove('active'));
            navButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${sectionId}-section`).classList.add('active');
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
            window[`fetch${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`]();
        }
        navButtons.forEach(button => button.addEventListener('click', () => showSection(button.dataset.section)));

        // --- FUNGSI HELPER ---
        function formatPrice(priceInUsd, currency) {
            let rate = 1, symbol = '$';
            if (currency === 'IDR') { rate = currencySettings.usd_rate; symbol = 'Rp '; }
            if (currency === 'EGP') { rate = currencySettings.egp_rate; symbol = 'E¬£ '; }
            const price = priceInUsd * rate;
            return `${symbol}${price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        
        // NEW: Function to calculate discounted price
        function calculateDiscountedPrice(basePrice, discount) {
            if (!discount) return basePrice;
            const discountPercent = parseFloat(discount.replace('%', '')) || 0;
            return basePrice * (1 - discountPercent / 100);
        }
        
        function slugify(text) { return text.toString().toLowerCase().replace(/\s+/g, '-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, ''); }
        async function uploadImage(file, folder) {
            if (!file) return null;
            const fileExt = file.name.split('.').pop();
            const fileName = `${folder}/${Date.now()}.${fileExt}`;
            const { data, error } = await supabase.storage.from(STORAGE_BUCKET).upload(fileName, file);
            if (error) { console.error('Error uploading image:', error); alert('Gagal mengunggah gambar.'); return null; }
            const { data: { publicUrl } } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(fileName);
            return publicUrl;
        }
        async function fetchData(tableName, tbodyId, loadingId, renderFunction) {
            document.getElementById(loadingId).style.display = 'block';
            const { data, error } = await supabase.from(tableName).select('*');
            if (error) { console.error(`Error fetching ${tableName}:`, error); document.getElementById(loadingId).textContent = 'Gagal memuat data.'; }
            else { renderFunction(data); document.getElementById(loadingId).style.display = 'none'; }
        }
        async function deleteItem(tableName, itemId, fetchFunction) {
            if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) return;
            const { error } = await supabase.from(tableName).delete().eq('id', itemId);
            if (error) { console.error(`Error deleting from ${tableName}:`, error); alert('Gagal menghapus data.'); }
            else { fetchFunction(); }
        }
        
        // --- MANAJEMEN BUKU (DIPERBARUI) ---
        const bookForm = document.getElementById('bookForm'); const booksTableBody = document.getElementById('booksTableBody');
        const bookFileInput = document.getElementById('bookCoverImageFile'); const bookUrlInput = document.getElementById('bookCoverImageUrl');
        const bookImagePreview = document.getElementById('bookImagePreview'); const bookPublisherSelect = document.getElementById('bookPublisherSelect');
        const bookDiscountInput = document.getElementById('bookDiscount');
        const bookBasePriceInput = document.getElementById('bookBasePrice');
        
        // NEW: Price display elements
        const displayBasePriceUSD = document.getElementById('displayBasePriceUSD');
        const displayDiscountPercent = document.getElementById('displayDiscountPercent');
        const displayFinalPriceUSD = document.getElementById('displayFinalPriceUSD');
        const displayFinalPriceIDR = document.getElementById('displayFinalPriceIDR');
        const displayFinalPriceEGP = document.getElementById('displayFinalPriceEGP');

        // NEW: Function to update price calculator
        function updatePriceCalculator() {
            const basePrice = parseFloat(bookBasePriceInput.value) || 0;
            const discount = bookDiscountInput.value || '0';
            const discountPercent = parseFloat(discount.replace('%', '')) || 0;
            const finalPriceUSD = calculateDiscountedPrice(basePrice, discount);
            
            displayBasePriceUSD.textContent = `$${basePrice.toFixed(2)}`;
            displayDiscountPercent.textContent = `${discountPercent}%`;
            displayFinalPriceUSD.textContent = `$${finalPriceUSD.toFixed(2)}`;
            displayFinalPriceIDR.textContent = formatPrice(finalPriceUSD, 'IDR');
            displayFinalPriceEGP.textContent = formatPrice(finalPriceUSD, 'EGP');
        }

        // NEW: Populate publisher dropdown
        async function populatePublisherDropdown() {
            const { data, error } = await supabase.from('publishers').select('id, name, discount');
            if (error) { console.error('Error fetching publishers:', error); return; }
            allPublishers = data;
            bookPublisherSelect.innerHTML = '<option value="">-- Pilih Penerbit --</option>' + data.map(p => `<option value="${p.id}" data-discount="${p.discount || ''}">${p.name}</option>`).join('');
        }

        // NEW: Handle publisher selection to auto-fill discount
        bookPublisherSelect.addEventListener('change', (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            bookDiscountInput.value = selectedOption.dataset.discount || '';
            updatePriceCalculator();
        });

        // NEW: Handle price and discount changes
        bookBasePriceInput.addEventListener('input', updatePriceCalculator);
        bookDiscountInput.addEventListener('input', updatePriceCalculator);

        // NEW: Handle image source selection (file vs URL)
        document.querySelectorAll('input[name="bookImageSource"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'upload') {
                    bookFileInput.style.display = 'block';
                    bookUrlInput.style.display = 'none';
                } else {
                    bookFileInput.style.display = 'none';
                    bookUrlInput.style.display = 'block';
                }
            });
        });

        // NEW: Handle preview for both file and URL
        bookFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) { bookImagePreview.src = URL.createObjectURL(file); bookImagePreview.style.display = 'block'; }
        });
        bookUrlInput.addEventListener('input', (e) => {
            if (e.target.value) { bookImagePreview.src = e.target.value; bookImagePreview.style.display = 'block'; }
            else { bookImagePreview.style.display = 'none'; }
        });

        // NEW: Updated renderBooks function to show discounted prices
        const renderBooks = (books) => {
            booksTableBody.innerHTML = books.map(book => {
                const basePrice = book.base_price || 0;
                const discount = book.discount || '0';
                const discountPercent = parseFloat(discount.replace('%', '')) || 0;
                const finalPriceUSD = calculateDiscountedPrice(basePrice, discount);
                
                return `
                <tr>
                    <td><img src="${book.cover_image_url || 'https://via.placeholder.com/60x60.png?text=No+Image'}" class="table-image" alt="Cover"></td>
                    <td>
                        <strong>${book.title}</strong><br>
                        <small>Penulis: ${book.author}</small>
                    </td>
                    <td class="price-display">
                        <span class="original-price">${formatPrice(basePrice, 'USD')}</span>
                        <span class="discounted-price">${formatPrice(finalPriceUSD, 'USD')}</span>
                        ${discountPercent > 0 ? `<span class="discount-badge">-${discountPercent}%</span>` : ''}
                    </td>
                    <td class="price-display">
                        <span class="original-price">${formatPrice(basePrice, 'IDR')}</span>
                        <span class="discounted-price">${formatPrice(finalPriceUSD, 'IDR')}</span>
                    </td>
                    <td class="price-display">
                        <span class="original-price">${formatPrice(basePrice, 'EGP')}</span>
                        <span class="discounted-price">${formatPrice(finalPriceUSD, 'EGP')}</span>
                    </td>
                    <td>${discount || '-'}</td>
                    <td class="action-buttons">
                        <button class="edit-btn" data-id="${book.id}">Edit</button>
                        <button class="delete-btn" data-id="${book.id}">Hapus</button>
                    </td>
                </tr>`;
            }).join('');
        };
        
        window.fetchBooks = () => fetchData('books', 'booksTableBody', 'loadingBooks', renderBooks);

        bookForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const submitBtn = document.querySelector('#bookForm .submit-btn'); submitBtn.disabled = true; submitBtn.textContent = 'Menyimpan...';
            const bookId = document.getElementById('bookId').value;
            const bookData = { 
                title: document.getElementById('bookTitle').value, 
                author: document.getElementById('bookAuthor').value, 
                original_price: parseFloat(document.getElementById('bookOriginalPrice').value), 
                base_price: parseFloat(document.getElementById('bookBasePrice').value), 
                volumes: document.getElementById('bookVolumes').value, 
                pages: document.getElementById('bookPages').value, 
                year: document.getElementById('bookYear').value, 
                publisher_id: bookPublisherSelect.value || null, 
                discount: bookDiscountInput.value 
            };
            
            // Handle image source
            let imageUrl = null;
            if (document.querySelector('input[name="bookImageSource"]:checked').value === 'url') {
                imageUrl = bookUrlInput.value;
            } else {
                const file = bookFileInput.files[0];
                if (file) { imageUrl = await uploadImage(file, 'books'); if (!imageUrl) { submitBtn.disabled = false; submitBtn.textContent = 'Tambah Buku'; return; } }
                else { imageUrl = document.getElementById('bookOldCoverUrl').value; }
            }
            bookData.cover_image_url = imageUrl;

            const { error } = bookId ? await supabase.from('books').update(bookData).eq('id', bookId) : await supabase.from('books').insert([bookData]);
            if (error) alert('Gagal menyimpan buku.'); else { if (!bookId) bookForm.reset(); resetBookForm(); }
            submitBtn.disabled = false; submitBtn.textContent = bookId ? 'Perbarui Buku' : 'Tambah Buku';
            window.fetchBooks();
        });
        
        booksTableBody.addEventListener('click', async (e) => {
            const id = e.target.dataset.id; if (e.target.classList.contains('delete-btn')) await deleteItem('books', id, window.fetchBooks);
            if (e.target.classList.contains('edit-btn')) {
                const { data } = await supabase.from('books').select('*').eq('id', id).single();
                if(data) {
                    document.getElementById('bookId').value = data.id; 
                    document.getElementById('bookTitle').value = data.title; 
                    document.getElementById('bookAuthor').value = data.author; 
                    document.getElementById('bookOriginalPrice').value = data.original_price; 
                    document.getElementById('bookBasePrice').value = data.base_price; 
                    document.getElementById('bookVolumes').value = data.volumes; 
                    document.getElementById('bookPages').value = data.pages; 
                    document.getElementById('bookYear').value = data.year; 
                    document.getElementById('bookOldCoverUrl').value = data.cover_image_url || '';
                    bookPublisherSelect.value = data.publisher_id || '';
                    bookDiscountInput.value = data.discount || '';
                    
                    // Update price calculator
                    updatePriceCalculator();
                    
                    if(data.cover_image_url) { 
                        bookImagePreview.src = data.cover_image_url; 
                        bookImagePreview.style.display = 'block'; 
                    }
                    
                    document.getElementById('booksFormTitle').textContent = 'Edit Buku'; 
                    document.querySelector('#bookForm .submit-btn').textContent = 'Perbarui Buku'; 
                    document.getElementById('cancelEditBook').style.display = 'inline-block';
                    bookForm.scrollIntoView({ behavior: 'smooth' });
                }
            }
        });
        
        function resetBookForm() { 
            bookForm.reset(); 
            document.getElementById('bookId').value = ''; 
            document.getElementById('bookOldCoverUrl').value = ''; 
            bookImagePreview.style.display = 'none'; 
            document.getElementById('booksFormTitle').textContent = 'Tambah Buku Baru'; 
            document.querySelector('#bookForm .submit-btn').textContent = 'Tambah Buku'; 
            document.getElementById('cancelEditBook').style.display = 'none'; 
            bookFileInput.style.display='block'; 
            bookUrlInput.style.display='none';
            updatePriceCalculator(); // Reset price calculator
        }
        
        document.getElementById('cancelEditBook').addEventListener('click', resetBookForm);

        // --- MANAJEMEN KATEGORI (DIPERBARUI) ---
        const categoryForm = document.getElementById('categoryForm'); const categoriesTableBody = document.getElementById('categoriesTableBody');
        const categoryFileInput = document.getElementById('categoryImageFile'); const categoryImagePreview = document.getElementById('categoryImagePreview');
        const categoryNameIdInput = document.getElementById('categoryNameId'); const categoryLinkInput = document.getElementById('categoryLink');

        // NEW: Auto-generate link from name
        categoryNameIdInput.addEventListener('input', (e) => {
            categoryLinkInput.value = `/kategori/${slugify(e.target.value)}`;
        });

        const renderCategories = (categories) => {
            categoriesTableBody.innerHTML = categories.map(c => `
                <tr>
                    <td><img src="${c.image_url || 'https://via.placeholder.com/60x60.png?text=No+Image'}" class="table-image" alt="Category"></td>
                    <td>${c.name_id}</td>
                    <td>${c.name_en}</td>
                    <td><span style="display:inline-block; width:20px; height:20px; background-color:${c.color}; border-radius:4px; vertical-align:middle;"></span> ${c.color}</td>
                    <td>${c.link ? `<a href="${c.link}" target="_blank">${c.link}</a>` : '-'}</td>
                    <td class="action-buttons"><button class="edit-btn" data-id="${c.id}">Edit</button><button class="delete-btn" data-id="${c.id}">Hapus</button></td>
                </tr>`).join('');
        };
        
        window.fetchCategories = () => fetchData('categories', 'categoriesTableBody', 'loadingCategories', renderCategories);
        categoryFileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { categoryImagePreview.src = URL.createObjectURL(file); categoryImagePreview.style.display = 'block'; } });
        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const submitBtn = document.querySelector('#categoryForm .submit-btn'); submitBtn.disabled = true; submitBtn.textContent = 'Menyimpan...';
            const categoryId = document.getElementById('categoryId').value;
            const categoryData = { name_id: document.getElementById('categoryNameId').value, name_en: document.getElementById('categoryNameEn').value, name_ar: document.getElementById('categoryNameAr').value, color: document.getElementById('categoryColor').value, link: categoryLinkInput.value };
            const file = categoryFileInput.files[0];
            if (file) { categoryData.image_url = await uploadImage(file, 'categories'); if (!categoryData.image_url) { submitBtn.disabled = false; submitBtn.textContent = 'Tambah Kategori'; return; } }
            else { categoryData.image_url = document.getElementById('categoryOldImageUrl').value; }
            const { error } = categoryId ? await supabase.from('categories').update(categoryData).eq('id', categoryId) : await supabase.from('categories').insert([categoryData]);
            if (error) alert('Gagal menyimpan kategori.'); else { if (!categoryId) categoryForm.reset(); resetCategoryForm(); }
            submitBtn.disabled = false; submitBtn.textContent = categoryId ? 'Perbarui Kategori' : 'Tambah Kategori';
            window.fetchCategories();
        });
        
        categoriesTableBody.addEventListener('click', async (e) => { 
            const id = e.target.dataset.id; 
            if (e.target.classList.contains('delete-btn')) await deleteItem('categories', id, window.fetchCategories);
            if (e.target.classList.contains('edit-btn')) { 
                const { data } = await supabase.from('categories').select('*').eq('id', id).single(); 
                if(data) { 
                    document.getElementById('categoryId').value = data.id; 
                    document.getElementById('categoryNameId').value = data.name_id; 
                    document.getElementById('categoryNameEn').value = data.name_en; 
                    document.getElementById('categoryNameAr').value = data.name_ar; 
                    document.getElementById('categoryColor').value = data.color; 
                    categoryLinkInput.value = data.link || ''; 
                    document.getElementById('categoryOldImageUrl').value = data.image_url || ''; 
                    if(data.image_url) { 
                        categoryImagePreview.src = data.image_url; 
                        categoryImagePreview.style.display = 'block'; 
                    } else { 
                        categoryImagePreview.style.display = 'none'; 
                    } 
                    document.getElementById('categoriesFormTitle').textContent = 'Edit Kategori'; 
                    document.querySelector('#categoryForm .submit-btn').textContent = 'Perbarui Kategori'; 
                    document.getElementById('cancelEditCategory').style.display = 'inline-block'; 
                    categoryForm.scrollIntoView({ behavior: 'smooth' }); 
                } 
            } 
        });
        
        function resetCategoryForm() { 
            categoryForm.reset(); 
            document.getElementById('categoryId').value = ''; 
            document.getElementById('categoryOldImageUrl').value = ''; 
            categoryImagePreview.style.display = 'none'; 
            document.getElementById('categoriesFormTitle').textContent = 'Tambah Kategori Baru'; 
            document.querySelector('#categoryForm .submit-btn').textContent = 'Tambah Kategori'; 
            document.getElementById('cancelEditCategory').style.display = 'none'; 
        }
        
        document.getElementById('cancelEditCategory').addEventListener('click', resetCategoryForm);
        
        // --- MANAJEMEN LAINNYA (TIDAK BERUBAH) ---
        const publisherForm = document.getElementById('publisherForm'); const publishersTableBody = document.getElementById('publishersTableBody'); const publisherFileInput = document.getElementById('publisherLogoFile'); const publisherImagePreview = document.getElementById('publisherImagePreview'); const renderPublishers = (publishers) => { publishersTableBody.innerHTML = publishers.map(p => `<tr><td><img src="${p.logo_url || 'https://via.placeholder.com/60x60.png?text=No+Logo'}" class="table-image" alt="Logo"></td><td>${p.name}</td><td>${p.letter}</td><td>${p.discount || '-'}</td><td class="action-buttons"><button class="edit-btn" data-id="${p.id}">Edit</button><button class="delete-btn" data-id="${p.id}">Hapus</button></td></tr>`).join(''); }; window.fetchPublishers = () => fetchData('publishers', 'publishersTableBody', 'loadingPublishers', renderPublishers); publisherFileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { publisherImagePreview.src = URL.createObjectURL(file); publisherImagePreview.style.display = 'block'; } }); publisherForm.addEventListener('submit', async (e) => { e.preventDefault(); const submitBtn = document.querySelector('#publisherForm .submit-btn'); submitBtn.disabled = true; submitBtn.textContent = 'Menyimpan...'; const publisherId = document.getElementById('publisherId').value; const publisherData = { name: document.getElementById('publisherName').value, letter: document.getElementById('publisherLetter').value, discount: document.getElementById('publisherDiscount').value }; const file = publisherFileInput.files[0]; if (file) { publisherData.logo_url = await uploadImage(file, 'publishers'); if (!publisherData.logo_url) { submitBtn.disabled = false; submitBtn.textContent = 'Tambah Penerbit'; return; } } else { publisherData.logo_url = document.getElementById('publisherOldLogoUrl').value; } const { error } = publisherId ? await supabase.from('publishers').update(publisherData).eq('id', publisherId) : await supabase.from('publishers').insert([publisherData]); if (error) alert('Gagal menyimpan penerbit.'); else { if (!publisherId) publisherForm.reset(); resetPublisherForm(); } submitBtn.disabled = false; submitBtn.textContent = publisherId ? 'Perbarui Penerbit' : 'Tambah Penerbit'; window.fetchPublishers(); }); publishersTableBody.addEventListener('click', async (e) => { const id = e.target.dataset.id; if (e.target.classList.contains('delete-btn')) await deleteItem('publishers', id, window.fetchPublishers); if (e.target.classList.contains('edit-btn')) { const { data } = await supabase.from('publishers').select('*').eq('id', id).single(); if(data) { document.getElementById('publisherId').value = data.id; document.getElementById('publisherName').value = data.name; document.getElementById('publisherLetter').value = data.letter; document.getElementById('publisherDiscount').value = data.discount; document.getElementById('publisherOldLogoUrl').value = data.logo_url || ''; if(data.logo_url) { publisherImagePreview.src = data.logo_url; publisherImagePreview.style.display = 'block'; } else { publisherImagePreview.style.display = 'none'; } document.getElementById('publishersFormTitle').textContent = 'Edit Penerbit'; document.querySelector('#publisherForm .submit-btn').textContent = 'Perbarui Penerbit'; document.getElementById('cancelEditPublisher').style.display = 'inline-block'; publisherForm.scrollIntoView({ behavior: 'smooth' }); } } }); function resetPublisherForm() { publisherForm.reset(); document.getElementById('publisherId').value = ''; document.getElementById('publisherOldLogoUrl').value = ''; publisherImagePreview.style.display = 'none'; document.getElementById('publishersFormTitle').textContent = 'Tambah Penerbit Baru'; document.querySelector('#publisherForm .submit-btn').textContent = 'Tambah Penerbit'; document.getElementById('cancelEditPublisher').style.display = 'none'; } document.getElementById('cancelEditPublisher').addEventListener('click', resetPublisherForm);
        const bannerForm = document.getElementById('bannerForm'); const bannersTableBody = document.getElementById('bannersTableBody'); const bannerFileInput = document.getElementById('bannerImageFile'); const bannerImagePreview = document.getElementById('bannerImagePreview'); const renderBanners = (banners) => { bannersTableBody.innerHTML = banners.map(b => `<tr><td><img src="${b.image_url || 'https://via.placeholder.com/60x60.png?text=No+Image'}" class="table-image" alt="Banner"></td><td>${b.title}</td><td>${b.type}</td><td>${b.display_order}</td><td class="action-buttons"><button class="edit-btn" data-id="${b.id}">Edit</button><button class="delete-btn" data-id="${b.id}">Hapus</button></td></tr>`).join(''); }; window.fetchBanners = () => fetchData('banners', 'bannersTableBody', 'loadingBanners', renderBanners); bannerFileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { bannerImagePreview.src = URL.createObjectURL(file); bannerImagePreview.style.display = 'block'; } }); bannerForm.addEventListener('submit', async (e) => { e.preventDefault(); const submitBtn = document.querySelector('#bannerForm .submit-btn'); submitBtn.disabled = true; submitBtn.textContent = 'Menyimpan...'; const bannerId = document.getElementById('bannerId').value; const bannerData = { title: document.getElementById('bannerTitle').value, type: document.getElementById('bannerType').value, display_order: parseInt(document.getElementById('bannerDisplayOrder').value) || 0 }; const file = bannerFileInput.files[0]; if (file) { bannerData.image_url = await uploadImage(file, 'banners'); if (!bannerData.image_url) { submitBtn.disabled = false; submitBtn.textContent = 'Tambah Banner'; return; } } else { bannerData.image_url = document.getElementById('bannerOldImageUrl').value; } const { error } = bannerId ? await supabase.from('banners').update(bannerData).eq('id', bannerId) : await supabase.from('banners').insert([bannerData]); if (error) alert('Gagal menyimpan banner.'); else { if (!bannerId) bannerForm.reset(); resetBannerForm(); } submitBtn.disabled = false; submitBtn.textContent = bannerId ? 'Perbarui Banner' : 'Tambah Banner'; window.fetchBanners(); }); bannersTableBody.addEventListener('click', async (e) => { const id = e.target.dataset.id; if (e.target.classList.contains('delete-btn')) await deleteItem('banners', id, window.fetchBanners); if (e.target.classList.contains('edit-btn')) { const { data } = await supabase.from('banners').select('*').eq('id', id).single(); if(data) { document.getElementById('bannerId').value = data.id; document.getElementById('bannerTitle').value = data.title; document.getElementById('bannerType').value = data.type; document.getElementById('bannerDisplayOrder').value = data.display_order; document.getElementById('bannerOldImageUrl').value = data.image_url || ''; if(data.image_url) { bannerImagePreview.src = data.image_url; bannerImagePreview.style.display = 'block'; } else { bannerImagePreview.style.display = 'none'; } document.getElementById('bannersFormTitle').textContent = 'Edit Banner'; document.querySelector('#bannerForm .submit-btn').textContent = 'Perbarui Banner'; document.getElementById('cancelEditBanner').style.display = 'inline-block'; bannerForm.scrollIntoView({ behavior: 'smooth' }); } } }); function resetBannerForm() { bannerForm.reset(); document.getElementById('bannerId').value = ''; document.getElementById('bannerOldImageUrl').value = ''; bannerImagePreview.style.display = 'none'; document.getElementById('bannersFormTitle').textContent = 'Tambah Banner Baru'; document.querySelector('#bannerForm .submit-btn').textContent = 'Tambah Banner'; document.getElementById('cancelEditBanner').style.display = 'none'; } document.getElementById('cancelEditBanner').addEventListener('click', resetBannerForm);
        const ordersTableBody = document.getElementById('ordersTableBody'); const renderOrders = (orders) => { ordersTableBody.innerHTML = orders.map(o => `<tr><td>${o.name}</td><td>${o.book_title}</td><td>Rp ${o.total_price.toLocaleString('id-ID')}</td><td>${o.status}</td><td>${new Date(o.created_at).toLocaleString('id-ID')}</td></tr>`).join(''); }; window.fetchOrders = () => fetchData('orders', 'ordersTableBody', 'loadingOrders', renderOrders);

        // --- CURRENCY SETTINGS MANAGEMENT ---
        const currencyForm = document.getElementById('currencyForm');
        window.fetchCurrency = async () => {
            const { data, error } = await supabase.from('site_settings').select('usd_rate, egp_rate').single();
            if (error) { console.error('Error fetching currency settings:', error); }
            else if (data) { currencySettings = { usd_rate: data.usd_rate, egp_rate: data.egp_rate }; document.getElementById('usdToIdr').value = currencySettings.usd_rate; document.getElementById('usdToEgp').value = currencySettings.egp_rate; }
        };
        currencyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newUsdRate = parseFloat(document.getElementById('usdToIdr').value);
            const newEgpRate = parseFloat(document.getElementById('usdToEgp').value);
            const { error } = await supabase.from('site_settings').update({ usd_rate: newUsdRate, egp_rate: newEgpRate }).eq('id', (await supabase.from('site_settings').select('id').single()).data.id);
            if (error) { alert('Gagal memperbarui pengaturan kurs.'); }
            else { 
                alert('Pengaturan kurs berhasil disimpan!'); 
                currencySettings.usd_rate = newUsdRate; 
                currencySettings.egp_rate = newEgpRate; 
                if (document.getElementById('books-section').classList.contains('active')) { 
                    window.fetchBooks(); 
                }
                // Update price calculator if on books form
                updatePriceCalculator();
            }
        });

        // --- INISIALISASI PERTAMA KALI ---
        window.fetchCurrency().then(() => {
            populatePublisherDropdown().then(() => {
                window.fetchBooks();
            });
        });
    });
    </script>
    <!-- ========================= JAVASCRIPT END ========================= -->

</body>
</html>
