<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toko Buku Islam - Beranda</title>
    <style>
        /* === FONT & ROOT VARIABLES === */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Lato:wght@400;700&display=swap');

        :root {
            --primary-blue: #3498db; /* Biru utama yang modern */
            --secondary-blue: #2980b9; /* Biru yang lebih gelap untuk hover */
            --white: #ffffff;
            --light-bg: #f8f9fa; /* Latar belakang yang sangat terang */
            --border-color: #e9ecef;
            --text-dark: #2c3e50; /* Abu-abu kebiruan gelap untuk teks */
            --text-light: #7f8c8d;
            --danger-red: #e74c3c;
            --success-green: #27ae60;
            --font-heading: 'Poppins', sans-serif;
            --font-body: 'Lato', sans-serif;
            --shadow-sm: 0 4px 6px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 8px 15px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }

        /* === GENERAL STYLES === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--light-bg);
            color: var(--text-dark);
            line-height: 1.7;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        section {
            padding: 4rem 0;
        }

        h1, h2, h3 {
            font-family: var(--font-heading);
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 2.5rem;
            font-size: 2.2rem;
            font-weight: 700;
        }

        /* === HEADER / NAVBAR === */
        header {
            background-color: var(--white);
            padding: 1rem 0;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 1000;
            width: 100%;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: var(--font-heading);
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-blue);
            text-decoration: none;
        }

        .search-bar {
            width: 40%;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 0.8rem 1.2rem 0.8rem 2.5rem; /* Padding untuk ikon */
            border-radius: 50px;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .search-bar input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .search-bar .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .currency-selector, .language-selector {
            margin-left: 0.5rem;
        }

        .currency-selector select, .language-selector select {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            border: 1px solid var(--border-color);
            background: var(--white);
            cursor: pointer;
        }

        /* === BREADCRUMB === */
        .breadcrumb {
            background-color: var(--white);
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .breadcrumb-list {
            display: flex;
            list-style: none;
            font-size: 0.9rem;
        }

        .breadcrumb-item {
            margin-right: 0.5rem;
        }

        .breadcrumb-item:not(:last-child)::after {
            content: "›";
            margin-left: 0.5rem;
            color: var(--text-light);
        }

        .breadcrumb-item a {
            color: var(--text-light);
            text-decoration: none;
        }

        .breadcrumb-item a:hover {
            color: var(--primary-blue);
        }

        .breadcrumb-item.active {
            color: var(--text-dark);
            font-weight: 500;
        }

        /* === HERO BANNERS === */
        .banner-slider {
            width: 100%;
            height: 450px;
            position: relative;
            overflow: hidden;
            border-radius: var(--border-radius);
            background: var(--border-color);
        }

        .banner-slide {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        .banner-slide.active {
            opacity: 1;
        }

        .banner-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* === PUBLISHERS SECTION (DIPINDAHKAN DI BAWAH BANNER) === */
        .publishers-section {
            padding: 2rem 0;
        }

        .publisher-slider {
            position: relative;
            overflow: hidden;
            padding: 1rem 0;
        }

        .publisher-track {
            display: flex;
            transition: transform 0.5s ease;
        }

        .publisher-slide {
            flex: 0 0 20%;
            padding: 0 0.5rem;
            box-sizing: border-box;
        }

        .publisher-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            text-decoration: none;
            color: var(--text-dark);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }

        .publisher-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .publisher-card-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem auto;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-blue);
            overflow: hidden;
        }
        
        .publisher-card-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .publisher-card h3 {
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* === CATEGORIES SECTION === */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
        }

        .category-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            text-decoration: none;
            color: var(--text-dark);
            cursor: pointer;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .category-card.active {
            border: 2px solid var(--primary-blue);
        }

        .category-card-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem auto;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-blue);
        }
        
        .category-card-icon img {
            width: 50%;
            height: 50%;
            object-fit: contain;
        }

        .category-card h3 {
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* === PRODUCTS SECTION === */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }

        .product-card {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .product-image {
            height: 250px;
            background-color: var(--light-bg);
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-info {
            padding: 1.2rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .product-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            height: 3.3em; /* Batas 2 baris */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .product-author {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .product-pricing {
            margin-top: auto;
        }

        .final-price {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-blue);
        }

        .original-price {
            font-size: 1rem;
            color: var(--text-light);
            text-decoration: line-through;
            margin-left: 0.5rem;
        }
        
        .discount-badge {
            background-color: var(--danger-red);
            color: var(--white);
            padding: 0.2rem 0.5rem;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        /* === PAGINATION === */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 2rem;
            gap: 0.5rem;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--white);
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .pagination button.active {
            background: var(--primary-blue);
            color: var(--white);
            border-color: var(--primary-blue);
        }

        .pagination button:hover {
            background: var(--secondary-blue);
            color: var(--white);
        }

        /* === MODAL === */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--border-radius);
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-light);
            background: none;
            border: none;
        }

        .modal-body {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
        }

        .modal-image img {
            width: 100%;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        
        .modal-info h2 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .modal-info .author {
            font-size: 1.1rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }
        .modal-info .pricing {
            margin: 1.5rem 0;
        }
        .modal-info .description {
            margin: 1rem 0;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.8rem;
            margin-top: 1rem;
            background: var(--light-bg);
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .detail-item {
            font-size: 0.9rem;
        }

        .detail-item strong {
            color: var(--text-dark);
            margin-right: 0.5rem;
        }
        
        .btn-buy, .btn-add-to-cart {
            display: inline-block;
            padding: 0.8rem 2rem;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s ease;
            margin-right: 1rem;
        }

        .btn-buy {
            background-color: var(--primary-blue);
            color: var(--white);
        }

        .btn-buy:hover {
            background-color: var(--secondary-blue);
        }

        .btn-add-to-cart {
            background-color: var(--success-green);
            color: var(--white);
        }

        .btn-add-to-cart:hover {
            background-color: #219d52;
        }

        /* === LOADER === */
        .loader-container {
            text-align: center;
            padding: 4rem;
        }
        
        .loader {
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--primary-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* === FILTER INFO === */
        .filter-info {
            background-color: var(--white);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .filter-info h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .filter-info p {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .clear-filter {
            background-color: var(--danger-red);
            color: var(--white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .clear-filter:hover {
            background-color: #c0392b;
        }

        /* === FOOTER === */
        footer {
            background-color: var(--text-dark);
            color: var(--light-bg);
            padding: 2rem 0;
            text-align: center;
        }

        /* === RESPONSIVE DESIGN === */
        @media (max-width: 992px) {
            .product-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .modal-body {
                grid-template-columns: 1fr;
            }
            .modal-image {
                max-width: 300px;
                margin: 0 auto;
            }
            .publisher-slide {
                flex: 0 0 25%;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 1rem;
            }
            .search-bar {
                width: 100%;
            }
            .product-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .section-title {
                font-size: 1.8rem;
            }
            .banner-slider {
                height: 350px;
            }
            .filter-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            .publisher-slide {
                flex: 0 0 33.33%;
            }
            .header-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        @media (max-width: 576px) {
            .product-grid {
                grid-template-columns: 1fr;
            }
            .details-grid {
                grid-template-columns: 1fr;
            }
            .publisher-slide {
                flex: 0 0 50%;
            }
        }
    </style>
</head>
<body>

    <header>
        <div class="container navbar">
            <a href="#" class="logo" id="homeLink">TokoBuku Islam</a>
            <div class="search-bar">
                <span class="search-icon">🔍</span>
                <input type="text" id="searchInput" placeholder="Cari judul atau penulis buku...">
            </div>
            <div class="header-controls">
                <div class="language-selector">
                    <select id="languageSelect">
                        <option value="id">Bahasa Indonesia</option>
                        <option value="en">English</option>
                        <option value="ar">العربية</option>
                    </select>
                </div>
                <div class="currency-selector">
                    <select id="currencySelect">
                        <option value="IDR">IDR (Rp)</option>
                        <option value="USD">USD ($)</option>
                        <option value="EGP">EGP (E£)</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <!-- Breadcrumb Navigation -->
    <div class="breadcrumb" id="breadcrumb" style="display: none;">
        <div class="container">
            <ul class="breadcrumb-list">
                <li class="breadcrumb-item"><a href="#" id="breadcrumbHome">Beranda</a></li>
                <li class="breadcrumb-item active" id="breadcrumbCurrent"></li>
            </ul>
        </div>
    </div>

    <main>
        <section id="banners-section" style="padding: 2rem 0 0 0;">
            <div class="container">
                <div id="bannerSlider" class="banner-slider">
                    <div class="loader-container">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Penerbit dipindahkan ke bawah banner -->
        <section id="publishers-section" class="publishers-section">
            <div class="container">
                <h2 class="section-title">Penerbit</h2>
                <div id="publisherSlider" class="publisher-slider">
                    <div id="publisherTrack" class="publisher-track">
                        <!-- Penerbit akan dimuat di sini -->
                    </div>
                </div>
            </div>
        </section>

        <section id="categories-section">
            <div class="container">
                <h2 class="section-title">Jelajahi Kategori</h2>
                <div id="categoryGrid" class="category-grid">
                    <div class="loader-container" style="grid-column: 1 / -1;">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="products-section" style="background-color: var(--white);">
            <div class="container">
                <div id="filterInfo" class="filter-info" style="display: none;">
                    <div>
                        <h3 id="filterTitle"></h3>
                        <p id="filterDescription"></p>
                    </div>
                    <button class="clear-filter" id="clearFilter">Hapus Filter</button>
                </div>
                <h2 class="section-title" id="productsTitle">Koleksi Buku Terbaru</h2>
                <div id="productGrid" class="product-grid">
                    <div class="loader-container" style="grid-column: 1 / -1;">
                        <div class="loader"></div>
                    </div>
                </div>
                <div id="pagination" class="pagination"></div>
            </div>
        </section>
    </main>
    
    <footer>
        <div class="container">
            <p>&copy; 2025 Toko Buku Islam. Hak Cipta Dilindungi.</p>
        </div>
    </footer>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <button id="modalClose" class="modal-close">&times;</button>
            <div id="modalBody" class="modal-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ==================== KONFIGURASI SUPABASE ====================
            const supabaseUrl = 'https://rfqpsuzmonfmnvthxinb.supabase.co';
            const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmcXBzdXptb25mbW52dGh4aW5iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1OTQyMjUsImV4cCI6MjA3NjE3MDIyNX0.gJFzuE-KJrdSoIKMTIDszTdNLDl_sJkIhgo7wmXRGWA';
            const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

            // ==================== VARIABEL GLOBAL & STATE ====================
            let allBooks = [];
            let categories = [];
            let publishers = [];
            let currencySettings = { usd_rate: 16000, egp_rate: 50 }; // Default, akan di-update
            let currentBannerIndex = 0;
            let currentPublisherIndex = 0;
            let currentCurrency = 'IDR';
            let currentLanguage = 'id';
            let selectedCategory = null;
            let selectedPublisher = null;
            let currentPage = 1;
            const booksPerPage = 8; // Tambahkan pagination dengan 8 buku per halaman
            let publisherInterval;

            // ==================== FUNGSI HELPER ====================
            function formatPrice(price, currency = 'IDR') {
                let rate = 1, symbol = 'Rp ', locale = 'id-ID';
                if (currency === 'USD') {
                    symbol = '$';
                    locale = 'en-US';
                    currency = 'USD';
                    rate = 1;
                } else if (currency === 'EGP') {
                    rate = currencySettings.egp_rate;
                    symbol = 'E£ ';
                    locale = 'en-EG';
                    currency = 'EGP';
                } else { // IDR
                    rate = currencySettings.usd_rate;
                    currency = 'IDR';
                }
                
                return new Intl.NumberFormat(locale, {
                    style: 'currency',
                    currency: currency,
                    minimumFractionDigits: 0
                }).format(price * rate).replace('IDR', 'Rp').replace('USD', '$').replace('EGP', 'E£');
            }

            function calculateDiscountedPrice(basePrice, discount) {
                if (!basePrice) return 0;
                if (!discount) return basePrice;
                const discountPercent = parseFloat(discount.replace('%', '')) || 0;
                return basePrice * (1 - discountPercent / 100);
            }

            function navigateToCategory(categoryId) {
                const url = new URL(window.location);
                url.searchParams.set('category', categoryId);
                url.searchParams.delete('publisher');
                window.location.href = url.toString();
            }

            function navigateToPublisher(publisherId) {
                const url = new URL(window.location);
                url.searchParams.set('publisher', publisherId);
                url.searchParams.delete('category');
                window.location.href = url.toString();
            }

            function navigateToHome() {
                const url = new URL(window.location);
                url.searchParams.delete('category');
                url.searchParams.delete('publisher');
                window.location.href = url.toString();
            }

            function updateBreadcrumb(filterType, filterName) {
                const breadcrumb = document.getElementById('breadcrumb');
                const breadcrumbCurrent = document.getElementById('breadcrumbCurrent');
                
                if (filterType) {
                    breadcrumb.style.display = 'block';
                    breadcrumbCurrent.textContent = filterName;
                } else {
                    breadcrumb.style.display = 'none';
                }
            }

            function updateFilterInfo(filterType, filterName, description) {
                const filterInfo = document.getElementById('filterInfo');
                const filterTitle = document.getElementById('filterTitle');
                const filterDescription = document.getElementById('filterDescription');
                const productsTitle = document.getElementById('productsTitle');
                
                if (filterType) {
                    filterInfo.style.display = 'flex';
                    filterTitle.textContent = filterName;
                    filterDescription.textContent = description;
                    productsTitle.textContent = `Buku ${filterName}`;
                } else {
                    filterInfo.style.display = 'none';
                    productsTitle.textContent = 'Koleksi Buku Terbaru';
                }
            }

            // ==================== FUNGSI FETCH DATA ====================
            async function fetchCurrency() {
                const { data, error } = await supabase.from('site_settings').select('usd_rate, egp_rate').single();
                if (!error && data) {
                    currencySettings = { usd_rate: data.usd_rate, egp_rate: data.egp_rate };
                }
            }
            
            async function fetchBanners() {
                const { data, error } = await supabase.from('banners').select('*').order('display_order', { ascending: true });
                if (!error && data) {
                    renderBanners(data);
                } else {
                    document.getElementById('bannerSlider').innerHTML = '<p>Gagal memuat banner.</p>';
                }
            }
            
            async function fetchCategories() {
                const { data, error } = await supabase.from('categories').select('*');
                if (!error && data) {
                    categories = data;
                    renderCategories(data);
                } else {
                    document.getElementById('categoryGrid').innerHTML = '<p>Gagal memuat kategori.</p>';
                }
            }

            async function fetchPublishers() {
                const { data, error } = await supabase.from('publishers').select('*');
                if (!error && data) {
                    publishers = data;
                    renderPublishers(data);
                    startPublisherSlider();
                } else {
                    document.getElementById('publisherTrack').innerHTML = '<p>Gagal memuat penerbit.</p>';
                }
            }

            async function fetchBooks() {
                // Mengambil data buku dan sekaligus data publisher terkait
                const { data, error } = await supabase.from('books').select('*, publishers(name)');
                if (!error && data) {
                    allBooks = data;
                    checkUrlParams();
                } else {
                    document.getElementById('productGrid').innerHTML = '<p>Gagal memuat data buku.</p>';
                }
            }
            
            // ==================== FUNGSI RENDER TAMPILAN ====================
            function renderBanners(banners) {
                const slider = document.getElementById('bannerSlider');
                if (!banners || banners.length === 0) {
                    slider.innerHTML = '<p>Tidak ada banner tersedia.</p>';
                    return;
                }
                
                slider.innerHTML = banners.map((banner, index) => `
                    <div class="banner-slide ${index === 0 ? 'active' : ''}">
                        <img src="${banner.image_url}" alt="${banner.title}">
                    </div>
                `).join('');
                
                // Start the slider functionality
                setInterval(() => {
                    const slides = document.querySelectorAll('.banner-slide');
                    slides[currentBannerIndex].classList.remove('active');
                    currentBannerIndex = (currentBannerIndex + 1) % slides.length;
                    slides[currentBannerIndex].classList.add('active');
                }, 5000); // Ganti banner setiap 5 detik
            }
            
            function renderCategories(cats) {
                const grid = document.getElementById('categoryGrid');
                if (!cats || cats.length === 0) {
                    grid.innerHTML = '<p>Tidak ada kategori tersedia.</p>';
                    return;
                }
                grid.innerHTML = cats.map(cat => `
                    <div class="category-card" data-category-id="${cat.id}" style="border-top: 5px solid ${cat.color};">
                        <div class="category-card-icon" style="background-color: ${cat.color};">
                            <img src="${cat.image_url || 'https://via.placeholder.com/40'}" alt="${cat.name_id}">
                        </div>
                        <h3>${cat.name_id}</h3>
                    </div>
                `).join('');

                // Tambahkan event listener untuk navigasi kategori
                document.querySelectorAll('.category-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const catId = card.dataset.categoryId;
                        navigateToCategory(catId);
                    });
                });
            }

            function renderPublishers(pubs) {
                const track = document.getElementById('publisherTrack');
                if (!pubs || pubs.length === 0) {
                    track.innerHTML = '<p>Tidak ada penerbit tersedia.</p>';
                    return;
                }
                track.innerHTML = pubs.map(pub => `
                    <div class="publisher-slide">
                        <div class="publisher-card" data-publisher-id="${pub.id}">
                            <div class="publisher-card-icon">
                                <img src="${pub.logo_url || 'https://via.placeholder.com/80'}" alt="${pub.name}">
                            </div>
                            <h3>${pub.name}</h3>
                        </div>
                    </div>
                `).join('');

                // Tambahkan event listener untuk navigasi penerbit
                document.querySelectorAll('.publisher-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const pubId = card.dataset.publisherId;
                        navigateToPublisher(pubId);
                    });
                });
            }

            function startPublisherSlider() {
                // Hentikan interval sebelumnya jika ada
                if (publisherInterval) {
                    clearInterval(publisherInterval);
                }
                
                const track = document.getElementById('publisherTrack');
                const slides = document.querySelectorAll('.publisher-slide');
                const totalSlides = slides.length;
                const slidesPerView = 5; // Jumlah slide yang terlihat sekaligus
                
                // Reset posisi
                currentPublisherIndex = 0;
                updatePublisherSlider();
                
                // Mulai slider otomatis
                publisherInterval = setInterval(() => {
                    currentPublisherIndex = (currentPublisherIndex + 1) % totalSlides;
                    updatePublisherSlider();
                }, 3000); // Ganti setiap 3 detik
            }
            
            function updatePublisherSlider() {
                const track = document.getElementById('publisherTrack');
                const slides = document.querySelectorAll('.publisher-slide');
                const slideWidth = slides[0].offsetWidth;
                
                // Geser track ke posisi yang sesuai
                track.style.transform = `translateX(-${currentPublisherIndex * slideWidth}px)`;
            }

            function checkUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const categoryId = urlParams.get('category');
                const publisherId = urlParams.get('publisher');
                
                if (categoryId) {
                    const category = categories.find(c => c.id == categoryId);
                    if (category) {
                        selectedCategory = categoryId;
                        updateBreadcrumb('category', category.name_id);
                        updateFilterInfo('category', category.name_id, `Menampilkan buku dari kategori ${category.name_id}`);
                    }
                } else if (publisherId) {
                    const publisher = publishers.find(p => p.id == publisherId);
                    if (publisher) {
                        selectedPublisher = publisherId;
                        updateBreadcrumb('publisher', publisher.name);
                        updateFilterInfo('publisher', publisher.name, `Menampilkan buku dari penerbit ${publisher.name}`);
                    }
                }
                
                currentPage = 1;
                filterAndRenderBooks();
            }

            function filterAndRenderBooks(searchTerm = '') {
                let filteredBooks = allBooks.filter(book => 
                    (book.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    book.author.toLowerCase().includes(searchTerm.toLowerCase())) &&
                    (!selectedCategory || book.category_id === parseInt(selectedCategory)) &&
                    (!selectedPublisher || book.publisher_id === parseInt(selectedPublisher))
                );

                const totalPages = Math.ceil(filteredBooks.length / booksPerPage);
                const paginatedBooks = filteredBooks.slice((currentPage - 1) * booksPerPage, currentPage * booksPerPage);

                renderBooks(paginatedBooks);
                renderPagination(totalPages);
            }

            function renderBooks(books) {
                const grid = document.getElementById('productGrid');
                if (!books || books.length === 0) {
                    grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">Tidak ada buku yang ditemukan.</p>';
                    return;
                }
                grid.innerHTML = books.map(book => {
                    const basePrice = book.base_price;
                    const originalPrice = book.original_price || basePrice; // Use original if available
                    const finalPrice = calculateDiscountedPrice(basePrice, book.discount);
                    const discountPercent = parseFloat(book.discount?.replace('%', '')) || 0;

                    return `
                        <div class="product-card" data-book-id="${book.id}">
                            <div class="product-image">
                                <img src="${book.cover_image_url || 'https://via.placeholder.com/300x400.png?text=No+Image'}" alt="${book.title}">
                            </div>
                            <div class="product-info">
                                <h3 class="product-title">${book.title}</h3>
                                <p class="product-author">oleh ${book.author}</p>
                                <div class="product-pricing">
                                    <span class="final-price">${formatPrice(finalPrice, currentCurrency)}</span>
                                    ${discountPercent > 0 || originalPrice > basePrice ? `<span class="original-price">${formatPrice(originalPrice, currentCurrency)}</span>` : ''}
                                    ${discountPercent > 0 ? `<span class="discount-badge">-${discountPercent}%</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Tambahkan event listener setelah card dirender
                document.querySelectorAll('.product-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const bookId = card.dataset.bookId;
                        openProductModal(bookId);
                    });
                });
            }

            function renderPagination(totalPages) {
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = '';
                for (let i = 1; i <= totalPages; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i;
                    if (i === currentPage) btn.classList.add('active');
                    btn.addEventListener('click', () => {
                        currentPage = i;
                        filterAndRenderBooks(document.getElementById('searchInput').value);
                    });
                    pagination.appendChild(btn);
                }
            }

            function renderModalContent(book) {
                const modalBody = document.getElementById('modalBody');
                const basePrice = book.base_price;
                const originalPrice = book.original_price || basePrice;
                const finalPrice = calculateDiscountedPrice(basePrice, book.discount);
                const discountPercent = parseFloat(book.discount?.replace('%', '')) || 0;

                modalBody.innerHTML = `
                    <div class="modal-image">
                        <img src="${book.cover_image_url || 'https://via.placeholder.com/300x400.png?text=No+Image'}" alt="${book.title}">
                    </div>
                    <div class="modal-info">
                        <h2>${book.title}</h2>
                        <p class="author">oleh <strong>${book.author}</strong></p>
                        <p class="publisher">Penerbit: <strong>${book.publishers ? book.publishers.name : 'N/A'}</strong></p>
                        
                        <div class="pricing">
                            <span class="final-price">${formatPrice(finalPrice, currentCurrency)}</span>
                            ${discountPercent > 0 || originalPrice > basePrice ? `<span class="original-price">${formatPrice(originalPrice, currentCurrency)}</span>` : ''}
                            ${discountPercent > 0 ? `<span class="discount-badge">-${discountPercent}%</span>` : ''}
                        </div>
                        
                        <p class="description">${book.description || 'Tidak ada deskripsi tersedia.'}</p>
                        
                        <div class="details-grid">
                            ${book.pages ? `<div class="detail-item"><strong>Halaman:</strong> ${book.pages}</div>` : ''}
                            ${book.year ? `<div class="detail-item"><strong>Tahun Terbit:</strong> ${book.year}</div>` : ''}
                            ${book.weight_value ? `<div class="detail-item"><strong>Berat:</strong> ${book.weight_value} ${book.weight_unit}</div>` : ''}
                            ${book.cover_type ? `<div class="detail-item"><strong>Jenis Cover:</strong> ${book.cover_type}</div>` : ''}
                            ${book.paper_type ? `<div class="detail-item"><strong>Jenis Kertas:</strong> ${book.paper_type}</div>` : ''}
                            ${book.volumes ? `<div class="detail-item"><strong>Jumlah Jilid:</strong> ${book.volumes}</div>` : ''}
                            ${book.text_color ? `<div class="detail-item"><strong>Warna Tulisan:</strong> ${book.text_color}</div>` : ''}
                            ${book.print_count ? `<div class="detail-item"><strong>Cetakan Ke:</strong> ${book.print_count}</div>` : ''}
                            ${book.editor ? `<div class="detail-item"><strong>Editor:</strong> ${book.editor}</div>` : ''}
                            ${book.isbn ? `<div class="detail-item"><strong>ISBN:</strong> ${book.isbn}</div>` : ''}
                            ${book.dimensions ? `<div class="detail-item"><strong>Dimensi:</strong> ${book.dimensions}</div>` : ''}
                            ${book.language ? `<div class="detail-item"><strong>Bahasa:</strong> ${book.language}</div>` : ''}
                            ${book.translator ? `<div class="detail-item"><strong>Penerjemah:</strong> ${book.translator}</div>` : ''}
                            ${book.reviewer ? `<div class="detail-item"><strong>Peninjau:</strong> ${book.reviewer}</div>` : ''}
                        </div>

                        <div style="margin-top: 2rem;">
                            <a href="#" class="btn-buy">🛒 Beli Sekarang</a>
                            <a href="#" class="btn-add-to-cart">➕ Tambah ke Keranjang</a>
                        </div>
                    </div>
                `;
            }

            // ==================== FUNGSI MODAL & PENCARIAN ====================
            const productModal = document.getElementById('productModal');
            const modalCloseBtn = document.getElementById('modalClose');

            async function openProductModal(bookId) {
                const book = allBooks.find(b => b.id == bookId);
                if (book) {
                    renderModalContent(book);
                    productModal.classList.add('active');
                }
            }

            function closeProductModal() {
                productModal.classList.remove('active');
            }

            modalCloseBtn.addEventListener('click', closeProductModal);
            productModal.addEventListener('click', (e) => {
                if (e.target === productModal) {
                    closeProductModal();
                }
            });

            document.getElementById('searchInput').addEventListener('keyup', (e) => {
                currentPage = 1;
                filterAndRenderBooks(e.target.value);
            });

            document.getElementById('currencySelect').addEventListener('change', (e) => {
                currentCurrency = e.target.value;
                filterAndRenderBooks(document.getElementById('searchInput').value);
                if (productModal.classList.contains('active')) {
                    const openBookId = document.querySelector('.product-card[data-book-id]')?.dataset.bookId;
                    if (openBookId) openProductModal(openBookId);
                }
            });

            document.getElementById('languageSelect').addEventListener('change', (e) => {
                currentLanguage = e.target.value;
                // Di sini bisa ditambahkan logika untuk mengubah bahasa seluruh konten website
                alert(`Bahasa diubah ke: ${e.target.options[e.target.selectedIndex].text}`);
            });

            document.getElementById('homeLink').addEventListener('click', (e) => {
                e.preventDefault();
                navigateToHome();
            });

            document.getElementById('breadcrumbHome').addEventListener('click', (e) => {
                e.preventDefault();
                navigateToHome();
            });

            document.getElementById('clearFilter').addEventListener('click', () => {
                navigateToHome();
            });

            // ==================== INISIALISASI APLIKASI ====================
            async function initializeApp() {
                await fetchCurrency(); // Ambil kurs dulu
                fetchBanners();
                fetchCategories();
                fetchPublishers();
                fetchBooks();
            }

            initializeApp();
        });
    </script>
</body>
</html>
